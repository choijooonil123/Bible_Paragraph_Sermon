<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>저장된 설교 낭독 + 단락별 저장/불러오기</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",sans-serif; margin: 24px; }
    h2 { margin: 0 0 12px; }
    .bar { display: flex; gap: 8px; align-items: center; margin: 8px 0 12px; flex-wrap: wrap; }
    #sermonBox {
      border: 1px solid #ddd; border-radius: 8px; padding: 12px;
      min-height: 280px; max-height: 60vh; overflow-y: auto;
      line-height: 1.7; white-space: pre-wrap; outline: none;
      background: #fafafa;
    }
    .line { padding: 2px 0; }
    .highlight { background: #fff59d; border-radius: 4px; }
    button {
      padding: 8px 14px; border-radius: 8px; border: 1px solid #ccc; background: #fff; cursor: pointer;
    }
    #btnRead.active { background: #9BE89B; border-color: #6bc66b; }
    .tip { color: #666; font-size: 0.92rem; }
    .muted { color: #888; font-size: 0.9rem; }
    #status { margin-left: 6px; font-size: 0.9rem; }
    .hidden { display: none; }
    pre.demo { margin:6px 0 0; background:#f6f6f6; padding:6px 8px; border-radius:6px; }
    .saved { background:#72b7ff !important; color:#fff; border-color:#3180e6 !important; }
  </style>
</head>
<body>
  <h2>저장된 설교 낭독 (절 단위 하이라이트)</h2>

  <div class="tip">
    특정 성경 단락을 선택한 후, 아래 박스에 설교문을 붙여넣으세요.<br>
    (한 줄 = 한 절)
  </div>

  <div class="bar">
    <select id="selBook">
      <option value="창세기-1-1-31">창세기 1:1–31</option>
      <option value="창세기-2-4-25">창세기 2:4–25</option>
      <option value="창세기-3-1-21">창세기 3:1–21</option>
    </select>
    <button id="btnRead">낭독</button>
    <button id="btnSave">저장</button>
    <button id="btnLoad">불러오기</button>
    <button id="btnPrint">인쇄</button>
    <button id="btnExport">전체 내보내기</button>
    <button id="btnImport">가져오기</button>
    <span id="status" class="muted">저장 안 됨</span>
    <input id="fileInput" type="file" accept=".json,application/json" class="hidden" />
  </div>

  <div id="sermonBox" contenteditable="true" spellcheck="false"
       placeholder="여기에 설교문을 붙여넣으세요."></div>

  <script>
    const box = document.getElementById('sermonBox');
    const btnRead = document.getElementById('btnRead');
    const btnSave = document.getElementById('btnSave');
    const btnLoad = document.getElementById('btnLoad');
    const btnPrint= document.getElementById('btnPrint');
    const btnExport = document.getElementById('btnExport');
    const btnImport = document.getElementById('btnImport');
    const fileInput = document.getElementById('fileInput');
    const statusEl = document.getElementById('status');
    const selBook = document.getElementById('selBook');

    let isReading = false, currentIndex = 0, lines = [];
    let dirty = false;

    const escapeHtml = s => s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const getPlainText = el => (el.innerText || el.textContent || '').replace(/\u00A0/g, ' ');
    const fmtDate = d => d.getFullYear()+String(d.getMonth()+1).padStart(2,'0')+String(d.getDate()).padStart(2,'0')+'-'+String(d.getHours()).padStart(2,'0')+String(d.getMinutes()).padStart(2,'0');

    function normalizeAndRender() {
      const raw = getPlainText(box).trim();
      lines = raw ? raw.split(/\r?\n/) : [];
      box.innerHTML = lines.map(l=>`<div class="line">${escapeHtml(l)}</div>`).join('');
      currentIndex = 0;
      clearHighlight();
    }
    function highlight(idx){
      [...box.children].forEach((el,i)=>el.classList.toggle('highlight', i===idx));
      box.children[idx]?.scrollIntoView({block:'center',behavior:'smooth'});
    }
    function clearHighlight(){ [...box.children].forEach(el=>el.classList.remove('highlight')); }

    function speakLine(text){ return new Promise(res=>{ const u=new SpeechSynthesisUtterance(text); u.lang='ko-KR'; u.onend=()=>res(); speechSynthesis.speak(u); }); }
    async function startReading(){
      normalizeAndRender();
      if(!lines.length){ stopReading(); return; }
      isReading=true; btnRead.classList.add('active'); btnRead.textContent='중지';
      for(let i=currentIndex;i<lines.length;i++){ if(!isReading) break; highlight(i); await speakLine(lines[i]); currentIndex=i+1; }
      stopReading();
    }
    function stopReading(){ isReading=false; speechSynthesis.cancel(); btnRead.classList.remove('active'); btnRead.textContent='낭독'; currentIndex=0; clearHighlight(); }

    function currentKey(){ return 'sermon-'+selBook.value; }

    function saveToLocal(){
      const raw = getPlainText(box);
      localStorage.setItem(currentKey(), JSON.stringify({html:raw,savedAt:new Date().toISOString()}));
      dirty=false;
      statusEl.textContent='저장됨 ('+fmtDate(new Date())+')';
      refreshSelectColors();
    }
    function loadFromLocal(){
      const raw=localStorage.getItem(currentKey());
      if(raw){ box.innerText=JSON.parse(raw).html; normalizeAndRender(); statusEl.textContent='불러옴'; } else { box.innerText=''; normalizeAndRender(); statusEl.textContent='저장본 없음'; }
      dirty=false;
    }
    function printCurrent(){
      const raw=localStorage.getItem(currentKey());
      const title=selBook.value.replace(/-/g,' ');
      const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title>
      <style>@media print{@page{size:A4;margin:25mm 20mm 20mm 20mm;}}body{font-family:"Noto Sans KR";padding:20px;}</style>
      </head><body><h2>${title} 설교</h2><pre>${escapeHtml(box.innerText)}</pre></body></html>`;
      const w=window.open(); w.document.write(html); w.document.close(); w.print();
    }

    function exportAll(){
      const all={};
      for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k.startsWith('sermon-')) all[k]=JSON.parse(localStorage.getItem(k)); }
      const blob=new Blob([JSON.stringify(all,null,2)],{type:"application/json"});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='sermons-'+fmtDate(new Date())+'.json'; a.click();
    }
    function importAll(file){
      const reader=new FileReader();
      reader.onload=()=>{ try{ const data=JSON.parse(reader.result); Object.keys(data).forEach(k=>{ if(k.startsWith('sermon-')) localStorage.setItem(k,JSON.stringify(data[k])); }); alert('가져오기 완료'); refreshSelectColors(); }catch(e){alert('불러오기 실패');} };
      reader.readAsText(file,'utf-8');
    }

    function refreshSelectColors(){
      [...selBook.options].forEach(opt=>{
        const key='sermon-'+opt.value;
        opt.classList.toggle('saved', !!localStorage.getItem(key));
      });
    }

    btnRead.addEventListener('click',()=>{ if(!isReading) startReading(); else stopReading(); });
    btnSave.addEventListener('click',saveToLocal);
    btnLoad.addEventListener('click',loadFromLocal);
    btnPrint.addEventListener('click',printCurrent);
    btnExport.addEventListener('click',exportAll);
    btnImport.addEventListener('click',()=>fileInput.click());
    fileInput.addEventListener('change',e=>{ if(e.target.files[0]) importAll(e.target.files[0]); e.target.value=''; });
    box.addEventListener('input',()=>{ dirty=true; statusEl.textContent='저장 필요'; if(isReading) stopReading(); normalizeAndRender(); });

    document.addEventListener('visibilitychange',()=>{ if(document.hidden&&isReading) stopReading(); });

    refreshSelectColors();
  </script>
</body>
</html>
